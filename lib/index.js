!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function n(n){for(var r=1;arguments.length>r;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?t(Object(a),!0).forEach(function(t){e(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(a,e))})}return n}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e,t,n){return(a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var a=[null];a.push.apply(a,t);var i=new(Function.bind.apply(e,a));return n&&r(i,n.prototype),i}).apply(null,arguments)}function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,a=!1,i=void 0;try{for(var o,l=e[Symbol.iterator]();!(r=(o=l.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function o(e){return function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);e.length>t;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var l=require("ethers"),u=require("cbor"),c=require("./PropositionLedger.json"),s=require("./RlayToken.json"),p=require("./builtins.json"),m=new l.Interface(c.abi),d=new l.Interface(s.abi),y=function(e,t){var r=e.toBigNubmer||e.utils.toBN,a=function(e){return n({},e,{totalWeight:r(e.totalWeight)})};return function(e){return e.aggregatedValue=e.aggregatedValue?a(e.aggregatedValue):null,e.canonicalNegativeValue=a(e.canonicalNegativeValue),e.canonicalPositiveValue=a(e.canonicalPositiveValue),e.values=e.values.map(a),e.positiveValues=e.positiveValues.map(a),e.negativeValues=e.negativeValues.map(a),e.totalWeight=r(e.totalWeight),e.totalWeightAggregationResult=e.totalWeightAggregationResult?r(e.totalWeightAggregationResult):null,e.totalWeightNegative=r(e.totalWeightNegative),e.totalWeightPositive=r(e.totalWeightPositive),e}(t)},f=function(e,t){return e.utils._.mapObject(t,function(e,t){return"type"===t?e:Array.isArray(e)?e.map(l.utils.hexlify):l.utils.hexlify(e)})},g=function(e,t,r){var a=d;return e.rlay.version().then(function(e){return e.contractAddresses}).then(function(i){var o=(0,a.functions.approve)(i.PropositionLedger,t).data;return e.eth.sendTransaction(n({to:i.RlayToken,data:o},r))})},x=function(e,t){return(0,ethersInterfaceOntologyStorage.functions["retrieve".concat(e)])(t).data},h=function(e,t){var n=ethersInterfaceOntologyStorage.functions["retrieve".concat(e)],r=n.parseResult(t),i={type:e};return n.outputs.names.forEach(function(e){var t=r[e];Array.isArray(t)&&(t=a(Array,o(t))),i[e.replace("_","")]=t}),i};module.exports={store:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.backend?e.rlay.experimentalStoreEntity(t,{backend:r.backend}):e.rlay.encodeForStore(t,r).then(function(t){var a=t.data;return e.rlay.version().then(function(e){return e.contractAddresses.OntologyStorage}).then(function(t){return e.eth.sendTransaction(n({to:t,data:a},r))}).then(function(e){return(new l.utils.AbiCoder).decode(["bytes"],e.logs[0].data)[0]})})},storeEntities:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n.backend)return e.rlay.experimentalStoreEntities(t,{backend:n.backend})},retrieve:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.rlay.experimentalGetEntity(t,r).then(function(a){if(a)return Promise.resolve(a);var o=e.rlay.version().then(function(e){return e.contractAddresses.OntologyStorage}),l=e.rlay.experimentalKindForCid(t).then(function(e){return e.kind});return Promise.all([o,l]).then(function(a){var o=i(a,2),l=o[0],u=o[1],c=x(u,t);return e.eth.call(n({to:l,data:c},r)).then(function(e){return h(u,e)})})})},setAllowance:g,addWeight:function(e,t,r,a){var i=m,o=a.setAllowance;return delete a.setAllowance,e.rlay.version().then(function(e){return e.contractAddresses}).then(function(l){var u=(0,i.functions.submitProposition)(t,r).data;return(o?g(e,r,a):Promise.resolve(null)).then(function(){return e.eth.sendTransaction(n({to:l.PropositionLedger,data:u},a))})})},encodeValue:function(e){return function(e){for(var t=[],n=0;e.length>n;n++)t.push((e[n]>>>4).toString(16)),t.push((15&e[n]).toString(16));return"0x".concat(t.join(""))}(u.encode(e))},decodeValue:function(e){return u.decodeFirstSync(e.substring(2,e.length))},extendWeb3WithRlay:function(e){e.extend({property:"rlay",methods:[{name:"version",call:"rlay_version"},{name:"getPropositionPools",call:"rlay_getPropositionPools",params:1,outputFormatter:function(t){return y(e,t)}},{name:"experimentalKindForCid",call:"rlay_experimentalKindForCid",params:1},{name:"experimentalListCids",call:"rlay_experimentalListCids",params:1},{name:"experimentalListCidsIndex",call:"rlay_experimentalListCidsIndex",params:3},{name:"experimentalGetEntity",call:"rlay_experimentalGetEntity",params:2},{name:"experimentalGetEntities",call:"rlay_experimentalGetEntities",params:2},{name:"experimentalResolveEntity",call:"rlay_experimentalResolveEntity",params:2},{name:"experimentalResolveEntities",call:"rlay_experimentalResolveEntities",params:2},{name:"experimentalGetEntityCid",call:"rlay_experimentalGetEntityCid",params:1,inputFormatter:[function(t){return f(e,t)}]},{name:"experimentalStoreEntity",call:"rlay_experimentalStoreEntity",params:2,inputFormatter:[function(t){return f(e,t)},null]},{name:"experimentalStoreEntities",call:"rlay_experimentalStoreEntities",params:2,inputFormatter:[function(t){return t.map(function(t){return f(e,t)})},null]},{name:"experimentalNeo4jQuery",call:"rlay_experimentalNeo4jQuery",params:2},{name:"encodeForStore",call:"rlay_encodeForStore",params:2,inputFormatter:[function(t){return f(e,t)},null]}]})},extendWeb3OldWithRlay:function(e){e._extend({property:"rlay",methods:[new e._extend.Method({name:"version",call:"rlay_version"}),new e._extend.Method({name:"getPropositionPools",call:"rlay_getPropositionPools",params:1,outputFormatter:function(t){return y(e,t)}}),new e._extend.Method({name:"experimentalKindForCid",call:"rlay_experimentalKindForCid",params:1}),new e._extend.Method({name:"experimentalListCids",call:"rlay_experimentalListCids",params:1}),new e._extend.Method({name:"experimentalListCidsIndex",call:"rlay_experimentalListCidsIndex",params:3}),new e._extend.Method({name:"experimentalGetEntity",call:"rlay_experimentalGetEntity",params:2}),new e._extend.Method({name:"experimentalGetEntities",call:"rlay_experimentalGetEntities",params:2}),new e._extend.Method({name:"experimentalResolveEntity",call:"rlay_experimentalResolveEntity",params:2}),new e._extend.Method({name:"experimentalResolveEntities",call:"rlay_experimentalResolveEntities",params:2}),new e._extend.Method({name:"experimentalGetEntityCid",call:"rlay_experimentalGetEntityCid",params:1,inputFormatter:[function(t){return f(e,t)}]}),new e._extend.Method({name:"experimentalStoreEntity",call:"rlay_experimentalStoreEntity",params:2,inputFormatter:[function(t){return f(e,t)},null]}),new e._extend.Method({name:"experimentalStoreEntities",call:"rlay_experimentalStoreEntities",params:2,inputFormatter:[function(t){return t.map(function(t){return f(e,t)})},null]}),new e._extend.Method({name:"experimentalNeo4jQuery",call:"rlay_experimentalNeo4jQuery",params:2}),new e._extend.Method({name:"encodeForStore",call:"rlay_encodeForStore",params:2,inputFormatter:[function(t){return f(e,t)},null]})]})},builtins:p}});
