!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(t){for(var n=1;arguments.length>n;n++){var r=null!=arguments[n]?arguments[n]:{},a=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),a.forEach(function(n){e(t,n,r[n])})}return t}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(e,t,a){return(r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,r){var a=[null];a.push.apply(a,t);var o=new(Function.bind.apply(e,a));return r&&n(o,r.prototype),o}).apply(null,arguments)}function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,a=!1,o=void 0;try{for(var i,l=e[Symbol.iterator]();!(r=(i=l.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function o(e){return function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);e.length>t;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var i=require("ethers"),l=require("cbor"),u=require("./PropositionLedger.json"),c=require("./RlayToken.json"),s=require("./builtins.json"),d=new i.Interface(u.abi),p=new i.Interface(c.abi),f=function(e,n){var r=e.toBigNubmer||e.utils.toBN,a=function(e){return t({},e,{totalWeight:r(e.totalWeight)})};return function(e){return e.aggregatedValue=e.aggregatedValue?a(e.aggregatedValue):null,e.canonicalNegativeValue=a(e.canonicalNegativeValue),e.canonicalPositiveValue=a(e.canonicalPositiveValue),e.values=e.values.map(a),e.positiveValues=e.positiveValues.map(a),e.negativeValues=e.negativeValues.map(a),e.totalWeight=r(e.totalWeight),e.totalWeightAggregationResult=e.totalWeightAggregationResult?r(e.totalWeightAggregationResult):null,e.totalWeightNegative=r(e.totalWeightNegative),e.totalWeightPositive=r(e.totalWeightPositive),e}(n)},y=function(e,t){return e.utils._.mapObject(t,function(e,t){return"type"===t?e:Array.isArray(e)?e.map(i.utils.hexlify):i.utils.hexlify(e)})},m=function(e,n,r){var a=p;return e.rlay.version().then(function(e){return e.contractAddresses}).then(function(o){var i=(0,a.functions.approve)(o.PropositionLedger,n).data;return e.eth.sendTransaction(t({to:o.RlayToken,data:i},r))})},g=function(e,t){return(0,ethersInterfaceOntologyStorage.functions["retrieve".concat(e)])(t).data},h=function(e,t){var n=ethersInterfaceOntologyStorage.functions["retrieve".concat(e)],a=n.parseResult(t),i={type:e};return n.outputs.names.forEach(function(e){var t=a[e];Array.isArray(t)&&(t=r(Array,o(t))),i[e.replace("_","")]=t}),i};module.exports={store:function(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.backend?e.rlay.experimentalStoreEntity(n,{backend:r.backend}):e.rlay.encodeForStore(n,r).then(function(n){var a=n.data;return e.rlay.version().then(function(e){return e.contractAddresses.OntologyStorage}).then(function(n){return e.eth.sendTransaction(t({to:n,data:a},r))}).then(function(e){return(new i.utils.AbiCoder).decode(["bytes"],e.logs[0].data)[0]})})},retrieve:function(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.rlay.experimentalGetEntity(n,r).then(function(o){if(o)return Promise.resolve(o);var i=e.rlay.version().then(function(e){return e.contractAddresses.OntologyStorage}),l=e.rlay.experimentalKindForCid(n).then(function(e){return e.kind});return Promise.all([i,l]).then(function(o){var i=a(o,2),l=i[0],u=i[1],c=g(u,n);return e.eth.call(t({to:l,data:c},r)).then(function(e){return h(u,e)})})})},setAllowance:m,addWeight:function(e,n,r,a){var o=d,i=a.setAllowance;return delete a.setAllowance,e.rlay.version().then(function(e){return e.contractAddresses}).then(function(l){var u=(0,o.functions.submitProposition)(n,r).data;return(i?m(e,r,a):Promise.resolve(null)).then(function(){return e.eth.sendTransaction(t({to:l.PropositionLedger,data:u},a))})})},encodeValue:function(e){return function(e){for(var t=[],n=0;e.length>n;n++)t.push((e[n]>>>4).toString(16)),t.push((15&e[n]).toString(16));return"0x".concat(t.join(""))}(l.encode(e))},decodeValue:function(e){return l.decodeFirstSync(e.substring(2,e.length))},extendWeb3WithRlay:function(e){e.extend({property:"rlay",methods:[{name:"version",call:"rlay_version"},{name:"getPropositionPools",call:"rlay_getPropositionPools",params:1,outputFormatter:function(t){return f(e,t)}},{name:"experimentalKindForCid",call:"rlay_experimentalKindForCid",params:1},{name:"experimentalListCids",call:"rlay_experimentalListCids",params:1},{name:"experimentalListCidsIndex",call:"rlay_experimentalListCidsIndex",params:3},{name:"experimentalGetEntity",call:"rlay_experimentalGetEntity",params:2},{name:"experimentalGetEntityCid",call:"rlay_experimentalGetEntityCid",params:1,inputFormatter:[function(t){return y(e,t)}]},{name:"experimentalStoreEntity",call:"rlay_experimentalStoreEntity",params:2,inputFormatter:[function(t){return y(e,t)},null]},{name:"experimentalNeo4jQuery",call:"rlay_experimentalNeo4jQuery",params:2},{name:"encodeForStore",call:"rlay_encodeForStore",params:2,inputFormatter:[function(t){return y(e,t)},null]}]})},extendWeb3OldWithRlay:function(e){e._extend({property:"rlay",methods:[new e._extend.Method({name:"version",call:"rlay_version"}),new e._extend.Method({name:"getPropositionPools",call:"rlay_getPropositionPools",params:1,outputFormatter:function(t){return f(e,t)}}),new e._extend.Method({name:"experimentalKindForCid",call:"rlay_experimentalKindForCid",params:1}),new e._extend.Method({name:"experimentalListCids",call:"rlay_experimentalListCids",params:1}),new e._extend.Method({name:"experimentalListCidsIndex",call:"rlay_experimentalListCidsIndex",params:3}),new e._extend.Method({name:"experimentalGetEntity",call:"rlay_experimentalGetEntity",params:2}),new e._extend.Method({name:"experimentalGetEntityCid",call:"rlay_experimentalGetEntityCid",params:1,inputFormatter:[function(t){return y(e,t)}]}),new e._extend.Method({name:"experimentalStoreEntity",call:"rlay_experimentalStoreEntity",params:2,inputFormatter:[function(t){return y(e,t)},null]}),new e._extend.Method({name:"experimentalNeo4jQuery",call:"rlay_experimentalNeo4jQuery",params:2}),new e._extend.Method({name:"encodeForStore",call:"rlay_encodeForStore",params:2,inputFormatter:[function(t){return y(e,t)},null]})]})},builtins:s}});
