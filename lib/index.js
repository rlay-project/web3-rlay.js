!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(t){for(var n=1;arguments.length>n;n++){var r=null!=arguments[n]?arguments[n]:{},a=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),a.forEach(function(n){e(t,n,r[n])})}return t}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(e,t,a){return(r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,r){var a=[null];a.push.apply(a,t);var i=new(Function.bind.apply(e,a));return r&&n(i,r.prototype),i}).apply(null,arguments)}function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,l=e[Symbol.iterator]();!(r=(o=l.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);e.length>t;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var o=require("ethers"),l=require("cbor"),u=require("./OntologyStorage.json"),c=require("./PropositionLedger.json"),s=require("./RlayToken.json"),p=require("./builtins.json"),d=new o.Interface(u.abi),f=new o.Interface(c.abi),y=new o.Interface(s.abi),m=function(e,n){var r=e.toBigNubmer||e.utils.toBN,a=function(e){return t({},e,{totalWeight:r(e.totalWeight)})};return function(e){return e.aggregatedValue=e.aggregatedValue?a(e.aggregatedValue):null,e.canonicalNegativeValue=a(e.canonicalNegativeValue),e.canonicalPositiveValue=a(e.canonicalPositiveValue),e.values=e.values.map(a),e.positiveValues=e.positiveValues.map(a),e.negativeValues=e.negativeValues.map(a),e.totalWeight=r(e.totalWeight),e.totalWeightAggregationResult=e.totalWeightAggregationResult?r(e.totalWeightAggregationResult):null,e.totalWeightNegative=r(e.totalWeightNegative),e.totalWeightPositive=r(e.totalWeightPositive),e}(n)},g=function(e,t){return e.utils._.mapObject(t,function(e,t){return"type"===t?e:Array.isArray(e)?e.map(o.utils.hexlify):o.utils.hexlify(e)})},h=function(e,n,r){var a=y;return e.rlay.version().then(function(e){return e.contractAddresses}).then(function(i){var o=(0,a.functions.approve)(i.PropositionLedger,n).data;return e.eth.sendTransaction(t({to:i.RlayToken,data:o},r))})},v=function(e){var t=d.functions["store".concat(e.type)],n=[];return t.inputs.names.forEach(function(r,a){var i="0x";t.inputs.types[a].endsWith("[]")&&(i=[]),n.push(e[r]||e[r.replace("_","")]||i)}),t.apply(void 0,n).data},x=function(e,t){return(0,d.functions["retrieve".concat(e)])(t).data},b=function(e,t){var n=d.functions["retrieve".concat(e)],a=n.parseResult(t),o={type:e};return n.outputs.names.forEach(function(e){var t=a[e];Array.isArray(t)&&(t=r(Array,i(t))),o[e.replace("_","")]=t}),o};module.exports={store:function(e,n,r){var a=d.functions["store".concat(n.type)];return r.backend?e.rlay.experimentalStoreEntity(n,{backend:r.backend}):e.rlay.version().then(function(e){return e.contractAddresses.OntologyStorage}).then(function(a){var i=v(n);return e.eth.sendTransaction(t({to:a,data:i},r))}).then(function(e){return a.parseResult(e.logs[0].data)[0]})},retrieve:function(e,n,r){return e.rlay.experimentalGetEntity(n).then(function(i){if(i)return Promise.resolve(i);var o=e.rlay.version().then(function(e){return e.contractAddresses.OntologyStorage}),l=e.rlay.experimentalKindForCid(n).then(function(e){return e.kind});return Promise.all([o,l]).then(function(i){var o=a(i,2),l=o[0],u=o[1],c=x(u,n);return e.eth.call(t({to:l,data:c},r)).then(function(e){return b(u,e)})})})},setAllowance:h,addWeight:function(e,n,r,a){var i=f,o=a.setAllowance;return delete a.setAllowance,e.rlay.version().then(function(e){return e.contractAddresses}).then(function(l){var u=(0,i.functions.submitProposition)(n,r).data;return(o?h(e,r,a):Promise.resolve(null)).then(function(){return e.eth.sendTransaction(t({to:l.PropositionLedger,data:u},a))})})},encodeValue:function(e){return l.encode(e)},decodeValue:function(e){return l.decodeFirstSync(e.substring(2,e.length))},encodeForStore:v,extendWeb3WithRlay:function(e){e.extend({property:"rlay",methods:[{name:"version",call:"rlay_version"},{name:"getPropositionPools",call:"rlay_getPropositionPools",params:1,outputFormatter:function(t){return m(e,t)}},{name:"experimentalKindForCid",call:"rlay_experimentalKindForCid",params:1},{name:"experimentalListCids",call:"rlay_experimentalListCids",params:1},{name:"experimentalListCidsIndex",call:"rlay_experimentalListCidsIndex",params:3},{name:"experimentalGetEntity",call:"rlay_experimentalGetEntity",params:2},{name:"experimentalGetEntityCid",call:"rlay_experimentalGetEntityCid",params:1,inputFormatter:[function(t){return g(e,t)}]},{name:"experimentalStoreEntity",call:"rlay_experimentalStoreEntity",params:2,inputFormatter:[function(t){return g(e,t)},null]}]})},extendWeb3OldWithRlay:function(e){e._extend({property:"rlay",methods:[new e._extend.Method({name:"version",call:"rlay_version"}),new e._extend.Method({name:"getPropositionPools",call:"rlay_getPropositionPools",params:1,outputFormatter:function(t){return m(e,t)}}),new e._extend.Method({name:"experimentalKindForCid",call:"rlay_experimentalKindForCid",params:1}),new e._extend.Method({name:"experimentalListCids",call:"rlay_experimentalListCids",params:1}),new e._extend.Method({name:"experimentalListCidsIndex",call:"rlay_experimentalListCidsIndex",params:3}),new e._extend.Method({name:"experimentalGetEntity",call:"rlay_experimentalGetEntity",params:2}),new e._extend.Method({name:"experimentalGetEntityCid",call:"rlay_experimentalGetEntityCid",params:1,inputFormatter:[function(t){return g(e,t)}]}),new e._extend.Method({name:"experimentalStoreEntity",call:"rlay_experimentalStoreEntity",params:2,inputFormatter:[function(t){return g(e,t)},null]})]})},builtins:p}});
